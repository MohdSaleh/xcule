<html>
    <head>
        <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
        <script src="https://momentjs.com/downloads/moment.js"></script>
    </head>

    <body style="margin: 0px;padding: 0px;">

        <div id="chart"></div>

        <div id="trades"></div>
     


        <script>
            
            var chart = LightweightCharts.createChart(document.getElementById('chart'), {
                width: document.body.scrollWidth,
                height: document.body.scrollHeight ,
                localization: {
                    dateFormat: 'yyyy-MM-dd'
                },
                layout: {
                    backgroundColor: '#252b4a',
                    textColor: 'rgba(255, 255, 255, 0.9)',
                },
                grid: {
                    vertLines: {
                        color: '#2e396163'
                    },
                    horzLines: {
                        color: '#2e396163'
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                priceScale: {
                    borderColor: '#1abae3',
                },
                timeScale: {
                    borderColor: '#1abae3',
                    // color:'#1abae3',
                    timeVisible: true,
                    secondsVisible: false,
                    rightOffset: 2,
                },
                watermark:{
                    visible:true,
                    text:"SMC-TD",
                    color:'#ffffff05'
                },
        
            });

        var candleSeries = chart.addCandlestickSeries({
            upColor: '#1ba36b',
            downColor: '#cd3e60', 
            borderDownColor: '#cd3e60',
            borderUpColor: '#1ba36b',
            wickDownColor: '#cd3e60',
            wickUpColor: '#1ba36b',
        });

        var extraSeries = chart.addLineSeries({
        // topColor: "rgba(255, 192, 0, 0.7)",
        // bottomColor: "rgba(255, 192, 0, 0.3)",
        lineColor: "green",
        lineWidth: 2
        });

        fetch('http://127.0.0.1:5000/history')
        .then((r) => r.json())
        .then((response) => {
            // console.log('respo',response)
            var set = response.history
            set.map((data)=>{
                data['time'] = timeToTz(data['time'])
            })
            console.log('respo',set)
            candleSeries.setData(set);
            console.log('dataee',JSON.parse(response.data))

            var lines = []
            // JSON.parse(response.data).map((item)=>{
            //     // mytime = moment().format("YYYY-MM-DD")
            //     if (item.max != null) {
            //         lines.push({time:timeToTz(item.time),value:item.max})
            //     }
            //     if (item.min != null) {
            //         lines.push({time:timeToTz(item.time),value:item.min})
            //     }
            // })        

            // console.log('sdsd',lines)
            // extraSeries.setData(lines)

        }).catch((err)=>console.log('error'))


        function timeToTz(originalTime) {
            const d = new Date(originalTime * 1000);
            return Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds(), d.getMilliseconds()) / 1000;
        }

        var binanceSocket = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_15m");

        binanceSocket.onmessage = function (event) {	
            var message = JSON.parse(event.data);
            var candlestick = message.k;
            candleSeries.update({
                time: timeToTz(candlestick.t/1000),
                open: candlestick.o,
                high: candlestick.h,
                low: candlestick.l,
                close: candlestick.c
            })
        }


        </script>
       
    </body>
</html>